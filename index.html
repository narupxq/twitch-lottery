<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex,nofollow">
  <link rel="icon" type="image/png" href="data:image/png;base64,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" />
  <meta property="og:type" content="website">
  <meta property="og:title" content="Twitch Channel Point ユーザー抽出ツール">
  <meta property="og:description" content="TwitchのChannel Point履歴ページからユーザー名を自動抽出。すべてブラウザ内で安全に処理されます。">
  <meta property="og:url" content="https://narupxq.github.io/twitch-lottery/">
  <meta property="og:image" content="https://narupxq.github.io/twitch-lottery/assets/images/ogp.png">
  <meta property="og:site_name" content="Twitch チャネポユーザー抽出ツール">
  <meta property="og:locale" content="ja_JP">
  <meta name="twitter:image" content="https://narupxq.github.io/twitch-lottery/assets/images/ogp.png">
  <title>Twitch チャネポユーザー抽出ツール</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    body {
      font-family: sans-serif;
    }

    p {
      margin: 0 0 8px;
    }
    
    /* ===== レイアウト全体 ===== */
    .page {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 20px;
      box-sizing: border-box;
      gap: 8px;
    }

    /* ===== 入力エリア ===== */
    textarea {
      width: 100%;
      flex: 4;               /* 40% */
      resize: vertical;
      box-sizing: border-box;
    }

    /* ===== 結果表示 ===== */
    pre {
      flex: 3;               /* 30% */
      background: #f5f5f5;
      padding: 10px;
      white-space: pre-wrap;
      overflow: auto;
      box-sizing: border-box;
    }
    
    /* 結果の各行 */
    .user-line {
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
    }

    .user-line:hover {
      background: #e0e0ff;
    }

    .user-line.active {
      background: #6a6aff;
      color: white;
    }
    /* ===== その他UI ===== */
    button {
      margin-right: 6px;
      padding: 6px 12px;
    }

    .copied {
      color: green;
      margin-left: 8px;
      font-size: 0.9em;
    }

    #countNum {
      font-size: 1.1em;
      font-weight: bold;
      background: linear-gradient(
        90deg,
        #ffcc00,
        #ff66cc,
        #66ccff,
        #ffcc00
      );
      background-size: 300% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: sparkle 3s linear infinite;
    }
  
    @keyframes sparkle {
      0%   { background-position:   0% 50%; }
      100% { background-position: 300% 50%; }
    }
  </style>
</head>
<body>
<div class="page">

  <h2>Twitch チャネポユーザー抽出ツール</h2>

  <h3>入力</h3>
  <p style="font-size: 0.9em; color: #555;">クリエイターダッシュボードから任意のチャンネルポイントの引き換え履歴を開き、表示されている内容をそのままコピーして貼り付けてください。</p>

  <textarea id="src" placeholder="（ここにTwitchの履歴をそのまま貼り付けてください）

例：

VIP1-Year SubscriberGifter Leader 2サンプルユーザー
(sample_user01)
19 時間前

2ヶ月のサブスクライバー
sample_user02
30 分前

VIP2ヶ月のサブスクライバー—sample_user03
3 日前

2ヶ月のサブスクライバー認証済みサンプル名 (sample_user04)
一昨日

VIP6ヶ月サブスクライバー
cheer100sampleuser05
8 日前

VIP6-Month SubscriberPrimeGamingsampleuser06
6 分前"></textarea>

  <h3>結果</h3>

  <div>
    <button onclick="copyResult()">結果をコピー</button>
    <span>抽出人数：</span><span id="countNum"></span><span></span>
    <span id="copyStatus" class="copied"></span>
  </div>

  <pre id="out"></pre>

  <p style="font-size: 0.9em; color: #555;">抽選サイトの入力欄に最初から入っている内容を削除し、貼り付けてください。</p>

  <p>
    <a href="https://www.randomdecider.com/ja/random-picker-wheel"
      target="_blank"
      rel="noopener noreferrer">
      抽選サイト を開く
    </a>
  </p>

  <p style="font-size: 0.9em; color: #555;">
    ※ 入力内容はすべてブラウザ内で処理されており、外部への送信は行われません。
  </p>
</div>

<script>
function extractUsers(text) {
  const blocks = text.trim().split(/\n\s*\n/);
  const result = [];

  let cursor = 0; // 元テキスト内の位置追跡用

  for (const block of blocks) {
    const startIndex = text.indexOf(block, cursor);
    cursor = startIndex + block.length;

    const lines = block
      .split('\n')
      .map(l => l.trim())
      .filter(Boolean);

    let targetLine = null;

    if (lines.length === 3) {
      targetLine = lines[1];
    } else if (lines.length === 2) { // たぶんこっちだけでいいはず。
      targetLine = lines[0];
    } else {
      continue;
    }

    // () があればユーザ名をそれとして最優先
    const parenMatch = targetLine.match(/\(([^)]+)\)/);
    if (parenMatch && /^[a-zA-Z0-9_]{4,25}$/.test(parenMatch[1])) {
      result.push({
        name: parenMatch[1],
        index: startIndex
      });
      continue;
    }

    // cheer・Subscriber・Prime Gaming 系を除去
    let cleaned = targetLine;
    const regex =
      /subscriber\s*\d*|サブスクライバー|音声なしで視聴中|音声のみ|認証済み|シーズン2|GamerDuo|Wylder|LEGENDUS|Raid\s*Race|Raging\s*Wolf\s*Helm|Turbo|Ugly\s*Sweater|prime\s*gaming|prime|gaming|vip|cheer\s*\d{1,3}(?:,\d{3})*|ビッツリーダー\s*\d*|subtember\s*\d{4}|twitch\s*recap\s*\d{4}|\d+(?:\.\d+)?\s*[- ]?\s*(?:year|month)s?|\d+\s*ヶ?月|20\d{2}/gi;

    while (true) {
      const next = cleaned.replace(regex, '');
      if (next === cleaned) break;
      cleaned = next;
    }

    cleaned = cleaned
      .replace(/\s+/g, ' ')
      .trim();

    // 末尾側からユーザー名抽出
    const matches = [...cleaned.matchAll(/[a-zA-Z0-9_]{4,25}/g)];
    if (matches.length > 0) {
      result.push({
        name: matches[matches.length - 1][0],
        index: startIndex
      });
    }
  }

  return result;
}

function run() {
  const text = document.getElementById('src').value;
  const users = extractUsers(text);

  const out = document.getElementById('out');
  out.innerHTML = users
    .map(u =>
      `<div class="user-line" data-index="${u.index}">${u.name}</div>`
    )
    .join('');

  document.getElementById('countNum').textContent = `${users.length} 人`;
  document.getElementById('copyStatus').textContent = '';

  // 結果エリアへスクロール
  out.scrollIntoView({ behavior: 'smooth' });
}

// 結果クリック時 → 入力欄の該当位置へ追従
document.getElementById('out').addEventListener('click', e => {
  if (!e.target.classList.contains('user-line')) return;

  const textarea = document.getElementById('src');
  const index = Number(e.target.dataset.index);

  textarea.focus();
  textarea.setSelectionRange(index, index);

  // caret 位置が見えるようにスクロール
  const totalLines = textarea.value.split('\n').length;
  const lineHeight = textarea.scrollHeight / totalLines;
  const caretLine = textarea.value.substr(0, index).split('\n').length;

  // 表示行数（概算）
  const visibleLines = textarea.clientHeight / lineHeight;

  // 3行分下げる
  textarea.scrollTop = lineHeight * textarea.value.substr(0, index).split('\n').length - lineHeight * 3;
});

function copyResult() {
  const lines = [...document.querySelectorAll('.user-line')]
    .map(el => el.textContent)
    .join('\n');

  if (!lines) return;

  navigator.clipboard.writeText(lines).then(() => {
    const el = document.getElementById('copyStatus');
    el.textContent = 'コピーしました。';
    setTimeout(() => el.textContent = '', 3000);
  });
}

// ===== 入力欄スクロール／カーソル移動 → 結果欄追従 =====
const textarea = document.getElementById('src');
const out = document.getElementById('out');

function syncResultHighlight() {
  const caret = textarea.selectionStart;
  const lines = [...document.querySelectorAll('.user-line')];

  if (!lines.length) return;

  // caret 位置以下で最も近い user-line を探す
  let current = null;
  for (const line of lines) {
    const index = Number(line.dataset.index);
    if (index <= caret) {
      current = line;
    } else {
      break;
    }
  }

  // ハイライト更新
  lines.forEach(l => l.classList.remove('active'));

  if (current) {
    current.classList.add('active');

    // 結果欄内で追従スクロール
    current.scrollIntoView({
      block: 'nearest',
      behavior: 'smooth'
    });
  }
}

// 入力欄イベント監視
['scroll', 'click', 'keyup'].forEach(evt => {
  textarea.addEventListener(evt, syncResultHighlight);
});

// ===== 入力即時抽出 =====
const srcTextarea = document.getElementById('src');

// 入力が変わるたびに自動抽出
srcTextarea.addEventListener('input', () => {
  run();
});
</script>

</body>
</html>
