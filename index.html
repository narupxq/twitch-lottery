<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex,nofollow">
  <link rel="icon" type="image/png" href="data:image/png;base64,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" />
  <meta property="og:type" content="website">
  <meta property="og:title" content="Twitch Channel Point ユーザー抽出ツール">
  <meta property="og:description" content="TwitchのChannel Point履歴ページからユーザー名を自動抽出。すべてブラウザ内で安全に処理されます。">
  <meta property="og:url" content="https://narupxq.github.io/twitch-lottery/">
  <meta property="og:image" content="https://narupxq.github.io/twitch-lottery/assets/images/ogp.png">
  <meta property="og:site_name" content="Twitch チャネポユーザー抽出ツール">
  <meta property="og:locale" content="ja_JP">
  <meta name="twitter:image" content="https://narupxq.github.io/twitch-lottery/assets/images/ogp.png">
  <title>Twitch チャネポユーザー抽出ツール</title>

  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    body {
      font-family: sans-serif;
    }

    p {
      margin: 0 0 8px;
    }

    .input-note {
      margin: 0 0 2px;
      font-size: 0.9em;
      color: #555;
    }

    h2,
    h3 {
      line-height: 1.2;
      margin-top: 0;
    }
    
    /* ===== レイアウト全体 ===== */
    .page {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
      gap: 8px;
    }

    /* ===== 入力エリア ===== */
    textarea {
      width: 100%;
      flex: 4;               /* 40% */
      resize: vertical;
      box-sizing: border-box;
    }

    /* ===== 結果表示 ===== */
    .results {
      display: flex;
      flex: 3;               /* 30% */
      gap: 12px;
      min-height: 0;
    }

    .result-panel,
    .summary-panel {
      display: flex;
      flex-direction: column;
      min-height: 0;
      background: #f5f5f5;
      padding: 10px;
      box-sizing: border-box;
      border-radius: 6px;
    }

    .result-panel {
      flex: 1;
    }

    .summary-panel {
      flex: 1;
    }

    .panel-title {
      margin: 0 0 8px;
      font-size: 0.95em;
    }

    pre {
      margin: 0;
      white-space: pre-wrap;
      overflow: auto;
      box-sizing: border-box;
    }

    #out {
      flex: 1;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      padding: 8px;
      background: #fff;
    }

    .summary-search {
      width: 100%;
      margin-bottom: 8px;
      padding: 6px 8px;
      box-sizing: border-box;
      font-size: 0.9em;
    }

    #summaryList {
      overflow: auto;
      flex: 1;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 2px 4px;
      border-radius: 4px;
    }

    .summary-row:nth-child(odd) {
      background: #ededed;
    }

    .summary-name-wrap {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
      flex: 1;
    }

    .summary-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 0;
    }

    .summary-count {
      font-weight: bold;
      min-width: 2.5em;
      text-align: right;
    }

    .summary-link {
      display: inline-flex;
      align-items: center;
      text-decoration: none;
      color: #1a0dab;
    }

    .summary-link:hover {
      text-decoration: underline;
    }

    .summary-link .material-symbols-outlined {
      font-size: 1em;
      line-height: 1;
    }

    @media (max-width: 900px) {
      .results {
        flex-direction: column;
      }
    }
    
    /* 結果の各行 */
    .user-line {
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
    }

    .user-line:hover {
      background: #e0e0ff;
    }

    .editor {
      display: flex;
      flex: 4;
      min-height: 0;
    }

    :root {
      --editor-font-size: 14px;
      --editor-line-height: 1.4;
      --editor-padding: 8px;
    }

    #lineNumbers {
      width: 36px;
      padding: var(--editor-padding) 4px;
      box-sizing: border-box;

      font-family: monospace;
      font-size: var(--editor-font-size);
      line-height: var(--editor-line-height);

      background: #f0f0f0;
      color: #666;
      text-align: right;
      user-select: none;
      overflow: hidden;
    }

    #src {
      flex: 1;
      font-family: monospace;
      font-size: var(--editor-font-size);
      line-height: var(--editor-line-height);
      padding: var(--editor-padding);
      box-sizing: border-box;
      overflow: auto;
    }

    .user-line.active {
      background: #6a6aff;
      color: white;
    }
    /* ===== その他UI ===== */
    button {
      margin-right: 6px;
      padding: 6px 12px;
    }

    .cta {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: #f5f5f5;
      border-radius: 8px;
    }

    .cta button {
      margin-right: 0;
    }

    .cta-text {
      color: #555;
      font-size: 0.95em;
    }

    .copied {
      color: green;
      margin-left: 8px;
      font-size: 0.9em;
    }

    #countNum {
      font-size: 1.1em;
      font-weight: bold;
      background: linear-gradient(
        90deg,
        #ffcc00,
        #ff66cc,
        #66ccff,
        #ffcc00
      );
      background-size: 300% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: sparkle 3s linear infinite;
    }
  
    @keyframes sparkle {
      0%   { background-position:   0% 50%; }
      100% { background-position: 300% 50%; }
    }
  </style>
</head>
<body>
<div class="page">

  <h2>Twitch チャネポユーザー抽出ツール</h2>

  <h3>入力</h3>
  <p class="input-note">クリエイターダッシュボードで任意のチャンネルポイントの引き換え履歴を開き、表示内容をそのままコピーして貼り付けてください。</p>
  <p class="input-note">ユーザーごとに空行で区切って入力してください。</p>

  <div class="editor">
    <div id="lineNumbers"></div>
    <textarea id="src" placeholder="（ここにTwitchの履歴をそのまま貼り付けてください）

例：

VIP1-Year SubscriberGifter Leader 2サンプルユーザー(sample_user01)
先月

Twitch Recap 2024sample_user07
先月

VIP6ヶ月サブスクライバーcheer100sampleuser05
25日前

モデレーター1年サブスクライバーcheer 100sample_user08
17日前

VIP2ヶ月のサブスクライバー—sample_user03
11日前

2ヶ月のサブスクライバー認証済みサンプル名(sample_user04)
8日前

サブスクライバーPrimesample_user09
一昨日

2ヶ月のサブスクライバーsample_user02
5時間前

VIP6-Month SubscriberPrimeGamingsampleuser06
30分前

VIPcheer 1,000sample_user10
6分前"></textarea></div>

  <div class="results">
    <div class="result-panel">
      <h4 class="panel-title">抽出結果</h4>
      <div>
        <span>抽出人数：</span><span id="countNum"></span>
        <span id="errorInfo" style="margin-left:12px; color:#c00;"></span>
      </div>
      <pre id="out"></pre>
    </div>
    <div class="summary-panel">
      <h4 class="panel-title">ユーザー別 チャンネルポイント交換数</h4>
      <input
        id="summarySearch"
        class="summary-search"
        type="text"
        placeholder="ユーザー名で検索"
        aria-label="ユーザー名で検索"
      />
      <div id="summaryList"></div>
    </div>
  </div>

  <div class="cta">
    <button onclick="copyResult()">結果をコピー</button>
    <span class="cta-text">してから</span>
    <a
      href="https://www.randomdecider.com/ja/random-picker-wheel"
      target="_blank"
      rel="noopener noreferrer">
      抽選サイト
    </a>
    <span class="cta-text">を開いて貼り付けてください。</span>
    <span id="copyStatus" class="copied"></span>
  </div>

  <p style="font-size: 0.9em; color: #555;">抽選サイトの入力欄に最初から入っている内容は削除してから貼り付けてください。</p>

  <p style="font-size: 0.9em; color: #555;">
    ※ 入力内容はすべてブラウザ内で処理されており、外部への送信は行われません。
  </p>
</div>

<script>
function extractUsers(text) {
  const blocks = text.split(/\n\s*\n/).filter(b => b.trim());
  const result = [];
  const errors = [];

  let cursor = 0;

  for (const block of blocks) {
    const startIndex = text.indexOf(block, cursor);
    cursor = startIndex + block.length;

    // 開始行番号（1始まり）
    const lineNumber =
      text.substring(0, startIndex).split('\n').length;

    const lines = block
      .split('\n')
      .map(l => l.trim())
      .filter(Boolean);

    // 1行なら「○日前」を自動補完してから解析する（途中までコピペされたとき用）
    let fixedLines = lines.slice(0, 2);
    if (fixedLines.length === 1) fixedLines = [fixedLines[0], '○日前'];

    let targetLine = null;

    // ユーザー名っぽい行を優先して拾う（() 内があれば最優先）
    targetLine =
      fixedLines.find(l => /\([a-zA-Z0-9_]{4,25}\)/.test(l)) ||
      fixedLines.find(l => /[a-zA-Z0-9_]{4,25}/.test(l)) ||
      fixedLines[0];

    if (!targetLine) {
      errors.push({ line: lineNumber });
      continue;
    }

    const parenMatch = targetLine.match(/\(([^)]+)\)/);
    if (parenMatch && /^[a-zA-Z0-9_]{4,25}$/.test(parenMatch[1])) {
      result.push({ name: parenMatch[1], index: startIndex });
      continue;
    }

    let cleaned = targetLine;
    const regex =
      /subscriber\s*\d*|サブスクライバー|音声なしで視聴中|音声のみ|認証済み|シーズン2|GamerDuo|Wylder|LEGENDUS|GLHF\s*Pledge|Raid\s*Race|Raging\s*Wolf\s*Helm|Turbo|Ugly\s*Sweater|prime\s*gaming|prime|gaming|vip|cheer\s*\d{1,3}(?:,\d{3})*|ビッツリーダー\s*\d*|subtember\s*\d{4}|twitch\s*recap\s*\d{4}|\d+(?:\.\d+)?\s*[- ]?\s*(?:year|month)s?|\d+\s*ヶ?月|20\d{2}/gi;

    while (true) {
      const next = cleaned.replace(regex, '');
      if (next === cleaned) break;
      cleaned = next;
    }

    cleaned = cleaned.replace(/\s+/g, ' ').trim();

    const matches = [...cleaned.matchAll(/[a-zA-Z0-9_]{4,25}/g)];
    if (matches.length > 0) {
      result.push({
        name: matches[matches.length - 1][0],
        index: startIndex
      });
    } else {
      errors.push({ line: lineNumber });
    }
  }

  return { users: result, errors };
}

function normalizeInputText(text) {
  // 改行コード統一
  const normalized = text.replace(/\r\n/g, '\n');

  if (!normalized) return '';

  const trailingMatch = normalized.match(/\n*$/);
  const trailingNewlines = trailingMatch ? trailingMatch[0] : '';
  let base = normalized.slice(0, normalized.length - trailingNewlines.length);

  if (base) {
    const blocks = base.split(/\n\s*\n/).filter(b => b.trim());
    const lastBlock = blocks[blocks.length - 1] || '';
    const lines = lastBlock
      .split('\n')
      .map(l => l.trim())
      .filter(Boolean);

    // 最後のブロックが1行だけでユーザー名っぽい場合は日付行を補完
    if (lines.length === 1 && /[a-zA-Z0-9_]{4,25}/.test(lines[0])) {
      base += '\n○日前';
    }
  }

  let result = base + trailingNewlines;

  if (!result.endsWith('\n\n')) {
    if (result.endsWith('\n')) result += '\n';
    else result += '\n\n';
  }

  return result;
}

function run() {
  const text = document.getElementById('src').value;
  const { users, errors } = extractUsers(text);

  const out = document.getElementById('out');
  out.innerHTML = users
    .map(u =>
      `<div class="user-line" data-index="${u.index}" data-login="${u.name}">${u.name}</div>`
    )
    .join('');

  document.getElementById('countNum').textContent = `${users.length} 人`;
  renderSummary(users);

  const errorInfo = document.getElementById('errorInfo');

  if (errors.length > 0) {
    errorInfo.innerHTML =
      '解釈不可：' +
      errors.map(e =>
        `<a href="#" class="error-jump" data-line="${e.line}">
          ${e.line}行目
        </a>`
      ).join(', ');

    // エラー行クリック → ジャンプ
    [...errorInfo.querySelectorAll('.error-jump')].forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        jumpToLine(Number(a.dataset.line));
      });
    });
  } else {
    errorInfo.textContent = '';
  }
}

const displayNameCache = new Map();
const displayNamePending = new Set();

async function fetchDisplayName(login) {
  if (!login) return null;
  if (displayNameCache.has(login)) return displayNameCache.get(login);
  if (displayNamePending.has(login)) return null;

  displayNamePending.add(login);
  try {
    const response = await fetch(
      `https://api.ivr.fi/v2/twitch/user?login=${encodeURIComponent(login)}`
    );
    if (!response.ok) throw new Error('not_found');
    const data = await response.json();
    const displayName = data?.[0]?.displayName || null;
    displayNameCache.set(login, displayName);
    return displayName;
  } catch {
    displayNameCache.set(login, null);
    return null;
  } finally {
    displayNamePending.delete(login);
  }
}

function applyDisplayName(login, displayName) {
  if (!displayName) return;
  const safeLogin = CSS.escape(login);
  const targets = document.querySelectorAll(
    `[data-login="${safeLogin}"]`
  );
  targets.forEach(el => {
    if (displayName === login) return;
    el.textContent = `${login}（${displayName}）`;
  });
}

function updateDisplayNames(container) {
  const names = [
    ...container.querySelectorAll('.summary-name[data-login]')
  ].map(el => el.dataset.login);
  const unique = [...new Set(names)];

  unique.forEach(async login => {
    const cached = displayNameCache.get(login);
    if (cached !== undefined) {
      applyDisplayName(login, cached);
      return;
    }
    const displayName = await fetchDisplayName(login);
    applyDisplayName(login, displayName);
  });
}

function renderSummary(users) {
  const query = (document.getElementById('summarySearch')?.value || '')
    .trim()
    .toLowerCase();
  const countMap = new Map();
  for (const user of users) {
    countMap.set(user.name, (countMap.get(user.name) || 0) + 1);
  }

  const rows = [...countMap.entries()]
    .map(([name, count]) => ({ name, count }))
    .filter(r => {
      if (!query) return true;
      if (r.name.toLowerCase().includes(query)) return true;
      const displayName = displayNameCache.get(r.name);
      if (!displayName) return false;
      return displayName.toLowerCase().includes(query);
    })
    .sort((a, b) => {
      if (b.count !== a.count) return b.count - a.count;
      return a.name.localeCompare(b.name, 'en');
    });

  const list = document.getElementById('summaryList');
  list.innerHTML = rows
    .map(r =>
      `<div class="summary-row">
        <span class="summary-name-wrap">
          <span class="summary-name" data-login="${r.name}">${r.name}</span>
          <a
            class="summary-link"
            href="https://www.twitch.tv/${r.name}"
            target="_blank"
            rel="noopener noreferrer"
            aria-label="Twitchのプロフィールを開く">
            <span class="material-symbols-outlined" aria-hidden="true">open_in_new</span>
          </a>
        </span>
        <span class="summary-count">${r.count}</span>
      </div>`
    )
    .join('');

  updateDisplayNames(list);
}

function jumpToLine(line) {
  const textarea = document.getElementById('src');
  const lines = textarea.value.split('\n');

  let index = 0;
  for (let i = 0; i < line - 1; i++) {
    index += lines[i].length + 1;
  }

  textarea.focus();
  textarea.setSelectionRange(index, index);

  const totalLines = lines.length;
  const lineHeight = textarea.scrollHeight / totalLines;

  const targetScrollTop = Math.max(
    0,
    lineHeight * (line - 3)
  );

  textarea.scrollTo({
    top: targetScrollTop,
    behavior: 'smooth'
  });

  syncResultHighlight();
}

// 結果クリック時 → 入力欄の該当位置へ追従
document.getElementById('out').addEventListener('click', e => {
  // user-line / error-line 以外は無視
  if (
    !e.target.classList.contains('user-line') &&
    !e.target.classList.contains('error-line')
  ) return;

  const textarea = document.getElementById('src');
  const index = Number(e.target.dataset.index);

  if (Number.isNaN(index)) return;

  textarea.focus();
  textarea.setSelectionRange(index, index);

  // caret 位置が見えるようにスクロール
  const beforeText = textarea.value.slice(0, index);
  const lineNumber = beforeText.split('\n').length;

  const totalLines = textarea.value.split('\n').length;
  const lineHeight = textarea.scrollHeight / totalLines;

  // 少し上に余裕を持たせて表示（3行分）
  const targetScrollTop = Math.max(
    0,
    lineHeight * (lineNumber - 3)
  );

  textarea.scrollTo({
    top: targetScrollTop,
    behavior: 'smooth'
  });

  syncResultHighlight();
});

function copyResult() {
  const lines = [...document.querySelectorAll('.user-line')]
    .map(el => el.textContent)
    .join('\n');

  if (!lines) return;

  navigator.clipboard.writeText(lines).then(() => {
    const el = document.getElementById('copyStatus');
    el.textContent = 'コピーしました。';
    setTimeout(() => el.textContent = '', 3000);
  });
}

const textarea = document.getElementById('src');
const lineNumbers = document.getElementById('lineNumbers');
const out = document.getElementById('out');
const summarySearch = document.getElementById('summarySearch');

function updateLineNumbers() {
  const lines = textarea.value.split('\n').length;
  let html = '';
  for (let i = 1; i <= lines; i++) {
    html += i + '<br>';
  }
  lineNumbers.innerHTML = html;
}

textarea.addEventListener('scroll', () => {
  lineNumbers.scrollTop = textarea.scrollTop;
});

summarySearch.addEventListener('input', () => {
  renderSummary(extractUsers(textarea.value).users);
});

function syncResultHighlight() {
  const caret = textarea.selectionStart;
  const lines = [...document.querySelectorAll('.user-line')];

  if (!lines.length) return;

  // caret 位置以下で最も近い user-line を探す
  let current = null;
  for (const line of lines) {
    const index = Number(line.dataset.index);
    if (index <= caret) {
      current = line;
    } else {
      break;
    }
  }

  // ハイライト更新
  lines.forEach(l => l.classList.remove('active'));

  if (current) {
    current.classList.add('active');

    // 結果欄内で追従スクロール
    current.scrollIntoView({
      block: 'nearest',
      behavior: 'smooth'
    });
  }
}

// 入力欄イベント監視
['scroll', 'click', 'keyup'].forEach(evt => {
  textarea.addEventListener(evt, syncResultHighlight);
});

// ===== 入力即時抽出 =====
const srcTextarea = document.getElementById('src');

// 置換ループ防止
let isNormalizing = false;

// 入力が変わるたびに自動抽出（かつ入力値を正規化して置き換え）
srcTextarea.addEventListener('input', () => {
  if (isNormalizing) return;

  const before = srcTextarea.value;
  const caretBefore = srcTextarea.selectionStart;
  const normalized = normalizeInputText(before);
  const beforeTrim = before.replace(/\n*$/, '');
  const normalizedTrim = normalized.replace(/\n*$/, '');
  const appendedAtEnd =
    normalized.length > before.length &&
    (normalizedTrim === beforeTrim ||
      normalizedTrim.startsWith(beforeTrim));

  if (before !== normalized) {
    isNormalizing = true;

    srcTextarea.value = normalized;

    const caret = appendedAtEnd
      ? srcTextarea.value.length
      : Math.min(caretBefore, srcTextarea.value.length);
    srcTextarea.setSelectionRange(caret, caret);

    isNormalizing = false;
  }

  updateLineNumbers();
  run();
});
</script>

</body>
</html>
